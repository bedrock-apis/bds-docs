import{spawn as e}from"node:child_process";import{platform as t,stderr as n,stdout as r}from"node:process";import{createWriteStream as i,existsSync as a}from"node:fs";import{chmod as o,mkdir as s,readFile as c,rm as l,writeFile as u}from"node:fs/promises";import{dirname as d,join as f,resolve as p}from"node:path";import{Writable as m}from"node:stream";const h=`__installation__`,g=Deno.env.get(`BRANCH_TO_UPDATE`)??null,ee=-1;var _=class extends Error{CODE;constructor(e,t){super(t),this.CODE=e}};let v=function(e){return e[e.UnsupportedPlatform=1]=`UnsupportedPlatform`,e[e.UnavailableInstallationLink=2]=`UnavailableInstallationLink`,e[e.BedrockServerProcessCriticalExit=17]=`BedrockServerProcessCriticalExit`,e[e.BedrockServerProcessExitedWithErrorCode=18]=`BedrockServerProcessExitedWithErrorCode`,e[e.SubModuleFailed=32]=`SubModuleFailed`,e}({});var y=class t{stopTimeout=3e3;process;promise;_timeout_ref=null;_was_redirected=!1;constructor(e){this.process=e;let{promise:t,resolve:n}=Promise.withResolvers();this.promise=t,this.process.on(`exit`,e=>{this._timeout_ref!==null&&clearTimeout(this._timeout_ref),this._timeout_ref=null,n(e)})}static async from(e){return new t(e)}static async run(t,n,r){let i=e(t,n??[],{cwd:r,stdio:[`pipe`]});return this.from(i)}enabledOutputRedirection(){this._was_redirected||(this.process.stdout.pipe(r),this.process.stderr.pipe(n),this._was_redirected=!0)}stop(e,t=this.stopTimeout){return this.process.exitCode===null?(this.process.stdin.write(`stop
`),e&&this._timeout_ref===null&&(this._timeout_ref=setTimeout(()=>void this.kill(),t??this.stopTimeout)),this.wait()):this.wait()}kill(){return this.process.kill(`SIGKILL`),this.wait()}runCommand(e){e=e.trim(),e.toLowerCase()===`stop`?this.stop(!1):this.process.stdin.write(e+`
`)}wait(){return this.promise}};let b=function(e){return e[e.LocalFileHeader=67324752]=`LocalFileHeader`,e[e.CentralDirectoryHeader=33639248]=`CentralDirectoryHeader`,e[e.DataDescriptor=134695760]=`DataDescriptor`,e[e.EndOfCentralDirectory=101010256]=`EndOfCentralDirectory`,e[e.ZIP64EndOfCentralDirectory=101075792]=`ZIP64EndOfCentralDirectory`,e[e.ZIP64EndOfCentralDirectoryLocator=117853008]=`ZIP64EndOfCentralDirectoryLocator`,e}({}),x=function(e){return e[e.Zip64=1]=`Zip64`,e[e.ExtendedTimestamp=21589]=`ExtendedTimestamp`,e[e.NTFS=10]=`NTFS`,e[e.StrongEncryption=23]=`StrongEncryption`,e[e.UnixUIDGID=30805]=`UnixUIDGID`,e[e.UnicodeFileName=30062]=`UnicodeFileName`,e[e.UnicodeComment=25461]=`UnicodeComment`,e[e.UTF8FileName=28789]=`UTF8FileName`,e[e.AES=39169]=`AES`,e[e.OS2ExtendedAttributes=20300]=`OS2ExtendedAttributes`,e[e.MacOSXMetadata=1992]=`MacOSXMetadata`,e[e.CentralDirectoryProtection=17217]=`CentralDirectoryProtection`,e[e.X509CertificatePKCS7=20]=`X509CertificatePKCS7`,e[e.X509CertificatePKCS7Attributes=21]=`X509CertificatePKCS7Attributes`,e[e.X509CertificatePKCS1RSA=22]=`X509CertificatePKCS1RSA`,e[e.WavPack=256]=`WavPack`,e[e.PPMdVersionI=257]=`PPMdVersionI`,e[e.IBMTERSE=24]=`IBMTERSE`,e}({}),te=function(e){return e[e.Store=0]=`Store`,e[e.Shrink=1]=`Shrink`,e[e.Reduce1=2]=`Reduce1`,e[e.Reduce2=3]=`Reduce2`,e[e.Reduce3=4]=`Reduce3`,e[e.Reduce4=5]=`Reduce4`,e[e.Implode=6]=`Implode`,e[e.Deflate=8]=`Deflate`,e[e.Deflate64=9]=`Deflate64`,e[e.PKWareImplode=10]=`PKWareImplode`,e[e.BZIP2=12]=`BZIP2`,e[e.LZMA=14]=`LZMA`,e[e.IBMTERSE_Old=16]=`IBMTERSE_Old`,e[e.IBMLZ77=17]=`IBMLZ77`,e[e.PPMd=18]=`PPMd`,e[e.IBMTERSE_New=19]=`IBMTERSE_New`,e[e.ZStandard=93]=`ZStandard`,e[e.XZ=98]=`XZ`,e[e.JPEG=99]=`JPEG`,e[e.WavPack=100]=`WavPack`,e[e.PPMdVersionI=101]=`PPMdVersionI`,e[e.AES=102]=`AES`,e}({});var ne=class e{static ReaderConstructor=class{constructor(e){this.dataProvider=e}createStreamController(){let e,t=new ReadableStream({start(t){e=t}});return{controller:e,readable:t}}*bufferUpController(e,t,n=!0){let r=0;for(;r<t;){let n=yield 1,i=Math.min(n,t-r);if(i===0)break;e.enqueue(this.rentSlice(i)),r+=i}n&&e.close()}createReadable(e){let{controller:t,readable:n}=this.createStreamController(),r=this.bufferUpController(t,e);return r.readable=n,r}*bufferUp(e){let t=0;for(;t<e.length;){let n=yield 1,r=Math.min(n,e.length-t);if(r===0)return e;e.set(this.rentSlice(r),t),t+=r}return e}*batchSkip(e){let t=0;for(;t<e;){let n=yield 1,r=Math.min(n,e-t);if(r===0)return;this.movePointer(r),t+=r}}movePointer(e){this.dataProvider.moveActivePointer(e)}rentSlice(e){let t=this.dataProvider.u8Array.slice(this.dataProvider.activePointer,this.dataProvider.activePointer+e);return this.movePointer(e),t}readUint8(){let e=this.dataProvider.view.getUint8(this.dataProvider.activePointer);return this.movePointer(1),e}readUint16(){let e=this.dataProvider.view.getUint16(this.dataProvider.activePointer,!0);return this.movePointer(2),e}readUint32(){let e=this.dataProvider.view.getUint32(this.dataProvider.activePointer,!0);return this.movePointer(4),e}readBigUint64(){let e=this.dataProvider.view.getBigUint64(this.dataProvider.activePointer,!0);return this.movePointer(8),e}rentDataView(e){let t=new DataView(this.dataProvider.buffer,this.dataProvider.view.byteOffset+this.dataProvider.activePointer,e);return this.movePointer(e),t}};reader=new e.ReaderConstructor(this);view;u8Array;absoluteOffset=0;_activePointer=0;get activePointer(){return this._activePointer}moveActivePointer(e){this._activePointer+=e,this.absoluteOffset+=e}activeLength=0;maxSubChunkSize;isRunning=!1;constructor(e,t){this.maxRequestedSize=e,this.buffer=t,this.view=new DataView(this.buffer),this.u8Array=new Uint8Array(this.buffer),this.maxSubChunkSize=t.byteLength-e}async consume(e){if(this.isRunning)throw ReferenceError(`Each consumer instance can run only one task at the time. You can reset this instance and run next task once current task quits.`);return void await this.process(e).finally(()=>this.isRunning=!1)}async process(t){this.isRunning=!0;let n=this.getProgram(),r=0,i=!1;for await(let a of t)for(let t of e.getChunkIterator(a,this.maxSubChunkSize)){if(i)continue;for(this.flush(),this.set(t);r<=this.activeLength-this.activePointer;){let{done:e,value:t}=n.next(this.activeLength-this.activePointer);if(e)return;if((r=t)===-1){r=this.activeLength=this._activePointer=0,i=!0;break}}}let a=n.next(this.activeLength-this.activePointer);for(;!a.done;)a=n.next(this.activeLength-this.activePointer)}set(e){if(this.activeLength+e.length>this.buffer.byteLength)throw Error(`Buffer overflow error, ${this.activeLength}, ${this.buffer.byteLength}, ${e.length}`);this.u8Array.set(e,this.activeLength),this.activeLength+=e.length}flush(){this.activePointer<=0||this.activeLength<=0||(this.u8Array.set(this.u8Array.subarray(this.activePointer,this.activeLength),0),this.activeLength-=this.activePointer,this._activePointer=0)}reset(){if(this.isRunning)throw ReferenceError(`Instance is locked, you can reset only instance with no tasks running.`);this.activeLength=0,this._activePointer=0}static*getChunkIterator(e,t){let n=0;for(;n<e.length;)yield e.subarray(n,n+=t)}};const S=256*2,C=256,w=16384+C,T=new TextDecoder(`utf-8`),E=26,D=42,O=18;var k=class{parsers;constructor(){this.parsers=Object.create(A)}registryParser(e,t){return this.parsers[e]=t,this}};const A={*[x.UnicodeFileName](e,t){yield 1;let n=e.readUint8();if(n!=1)return;yield 4,e.readUint32();let r=t.size-5;if(r>S)throw Error(`File name too long, bytes: `+r);let i=yield*e.bufferUp(new Uint8Array(r));return{path:T.decode(i)}},*[x.UTF8FileName](e,t){yield 1;let n=e.readUint8();if(n!=1)return;let r=t.size-1;if(r>S)throw Error(`File name too long, bytes: `+r);let i=yield*e.bufferUp(new Uint8Array(r));return{path:T.decode(i)}},*[x.Zip64](e){console.log(`Zip64`),yield 8;let t=Number(e.readBigUint64()),n=Number(e.readBigUint64());return{uncompressedSize:t,compressedSize:n}},*[x.ExtendedTimestamp](e){yield 1;let t=e.readUint8(),n={};return t&1&&(yield 4,n.modificationTime=e.readUint32()),t&2&&(yield 4,n.accessTime=e.readUint32()),t&4&&(yield 4,n.creationTime=e.readUint32()),n}};let j=function(e){return e[e.Encrypted=1]=`Encrypted`,e[e.CompressionOption1=2]=`CompressionOption1`,e[e.CompressionOption2=4]=`CompressionOption2`,e[e.HasDataDescriptor=8]=`HasDataDescriptor`,e[e.ReservedPkware1=16]=`ReservedPkware1`,e[e.StrongEncryption=32]=`StrongEncryption`,e[e.UTF8Encoding=2048]=`UTF8Encoding`,e[e.MaskHeaderValues=8192]=`MaskHeaderValues`,e}({});var M=class extends ne{static textDecoder=new TextDecoder;onFileRead;onDirectoryInfo;constructor(e=new k,t=new ArrayBuffer(w)){super(C,t),this.parser=e,this.buffer=t}*getProgram(){for(;;){let e=yield 4;if(e<4)throw SyntaxError(`Unexpected end of input`);let t=this.getMagic();if(this.reader.movePointer(4),typeof this[t]!=`function`)throw Error(`Unexpected magic number: `+t.toString(16)+` `+b[t]);let n=yield*this[t]();if(n){yield-1;return}}}*101010256(){let e=yield O;if(e<O)throw Error(`Invalid EndOfCentralDirectoryHeader size: `+e);let t=N.readEndOfCentralDirectoryHeader(this.reader);return yield*this.reader.batchSkip(t.commentLength),!0}*33639248(){let e=yield D;if(e<D)throw Error(`Invalid CentralDirectoryHeader size: `+e);let t=N.readCentralDirectoryHeader(this.reader);yield*this.reader.batchSkip(t.nameLength),yield*this.reader.batchSkip(t.extraDataLength),yield*this.reader.batchSkip(t.commentLength)}*67324752(){let e=yield E;if(e<E)return void console.error(`Invalid header size`);let t=N.readLocalFileHeader(this.reader);if(t.nameLength>S)throw Error(`File name path is too long: `+t.nameLength);if((yield t.nameLength)<t.nameLength)throw Error(`Unexpected end of input`);let n=T.decode(this.reader.rentSlice(t.nameLength)),r={time:t.time,date:t.date,compressionMethod:t.compressionMethod,bits:t.bitFlags,isZIP64:!1,isStreamSized:(t.bitFlags&j.HasDataDescriptor)===j.HasDataDescriptor,compressedSize:t.compressedSize,uncompressedSize:t.uncompressedSize,path:n,crc:t.crc},i=this.absoluteOffset;for(;this.absoluteOffset-i<t.extraDataLength;){let{id:e,size:t}=yield*this.readExtraDataHeader(),n=this.parser.parsers[e];if(n){let i=yield*n(this.reader,{id:e,size:t});typeof i==`object`&&Object.assign(r,i)}else yield*this.reader.batchSkip(t)}if(r.uncompressedSize===0&&!r.isStreamSized&&r.path.match(/^.*[\\/]{1}$/))return void this.onDirectoryInfo?.(r);let a,o;if(r.isStreamSized){let e=this.reader.createStreamController();a=e.readable,o=this.streamReadData(e.controller,r.isZIP64)}else{let e=o=this.reader.createReadable(r.compressedSize);a=e.readable}this.onFileRead?.(r,a),yield*o}*streamReadData(e,t){let n=t?24:16,r=t?e=>Number(this.view.getBigUint64(e,!0)):e=>this.view.getUint32(e,!0),i=0;for(;;){let a=yield n+1,o=a-n,s=this.activePointer,c=0;for(;c<=o;c++,i++)if(this.view.getUint32(s+c,!0)===b.DataDescriptor&&r(s+c+8)===i){e.enqueue(this.reader.rentSlice(c)),this.reader.movePointer(t?24:16),e.close();return}e.enqueue(this.reader.rentSlice(c))}}getMagic(){return this.view.getUint32(this.activePointer,!0)}*readExtraDataHeader(){if((yield 4)<4)throw Error(`Unexpected end of input`);return{id:this.reader.readUint16(),size:this.reader.readUint16()}}};let N;(function(e){function t(e){return{version:e.readUint16(),bitFlags:e.readUint16(),compressionMethod:e.readUint16(),time:e.readUint16(),date:e.readUint16(),crc:e.readUint32(),compressedSize:e.readUint32(),uncompressedSize:e.readUint32(),nameLength:e.readUint16(),extraDataLength:e.readUint16()}}e.readLocalFileHeader=t;function n(e){return{versionMadeBy:e.readUint16(),versionNeeded:e.readUint16(),bitFlags:e.readUint16(),compressionMethod:e.readUint16(),time:e.readUint16(),date:e.readUint16(),crc:e.readUint32(),compressedSize:e.readUint32(),uncompressedSize:e.readUint32(),nameLength:e.readUint16(),extraDataLength:e.readUint16(),commentLength:e.readUint16(),diskNumberStart:e.readUint16(),internalAttributes:e.readUint16(),externalAttributes:e.readUint32(),offsetLocalHeader:e.readUint32()}}e.readCentralDirectoryHeader=n;function r(e){return{diskNumber:e.readUint16(),centralDirectoryDisk:e.readUint16(),centralDirectoryRecordsOnDisk:e.readUint16(),totalCentralDirectoryRecords:e.readUint16(),centralDirectorySize:e.readUint32(),centralDirectoryOffset:e.readUint32(),commentLength:e.readUint16()}}e.readEndOfCentralDirectoryHeader=r;function i(e){return{versionMadeBy:e.readUint16(),versionNeeded:e.readUint16(),bitFlags:e.readUint16(),compressionMethod:e.readUint16(),time:e.readUint16(),date:e.readUint16(),crc:e.readUint32(),compressedSize:Number(e.readBigUint64()),uncompressedSize:Number(e.readBigUint64()),nameLength:e.readUint16(),extraDataLength:e.readUint16(),commentLength:e.readUint16(),diskNumberStart:e.readUint32(),internalAttributes:e.readUint16(),externalAttributes:e.readUint32(),offsetLocalHeader:Number(e.readBigUint64())}}e.readZIP64CentralDirectoryHeader=i;function a(e){return{diskWithEOCD:e.readUint32(),offsetEOCD:e.readBigUint64(),totalDisks:e.readUint32()}}e.readZip64EndOfCentralDirectoryLocator=a})(N||={});var P=class extends WritableStream{unzipExtractor;transformer=new TransformStream;constructor(e){super({abort:e=>t.abort(e),close:()=>t.close(),write:e=>t.write(e)}),this.unzipExtractor=e?.zipExtractor??new M;let t=this.transformer.writable.getWriter();this.unzipExtractor.consume(this.transformer.readable).catch(e=>{console.error(`Abort:`,e),t.abort(e)}),this.unzipExtractor.onFileRead=(t,r)=>e?.onFile?.(t,e?.pipeThrough?.(t,r)??n(t,r)),this.unzipExtractor.onDirectoryInfo=t=>e?.onDirectory?.(t);let n=(e,t)=>e.compressionMethod===te.Deflate?t.pipeThrough(new DecompressionStream(`deflate-raw`)):t}},F=class extends Map{constructor(e){super(),this.path=e}async load(e=!1){try{e&&this.clear();let t=(await c(this.path)).toString(`utf8`);for(let e of t.split(/\n|\r\n|\r/).map(e=>e.trim())){if(e.startsWith(`#`)||e===``)continue;let t=e.indexOf(`=`),n=e.substring(0,t),r=e.substring(t+1);r===`true`||r===`false`?r=r===`true`:isFinite(Number(r))&&(r=Number(r)),this.has(n)||this.set(n,r)}}catch{}return this}async save(){return await s(d(this.path)).catch(e=>null),await u(this.path,this.entries().map(([e,t])=>`${e}=${t}`).toArray().join(`
`)),this}merge(e){for(let t of Object.keys(e))this.set(t,e[t]);return this}},I=class{constructor(e){this.path=e}raw={};async load(){try{let e=(await c(this.path)).toString(`utf8`);this.raw=JSON.parse(e)}catch{}return this}getAllowedModules(){return Array.prototype.values.call(this.raw.allowed_modules??=[])}addAllowedModules(...e){this.raw.allowed_modules=new Set([...e,...this.raw.allowed_modules??[]]).values().toArray()}removeAllowedModules(...e){let t=new Set(this.raw.allowed_modules??[]);this.raw.allowed_modules=t.difference(new Set(e)).values().toArray()}async save(){return await s(d(this.path)).catch(e=>null),await u(this.path,JSON.stringify(this.raw,null,3)),this}};const L=`test_config.json`,R=`server.properties`,z=`permissions.json`,B=f(`config`,`default`),V=`world_behavior_packs.json`,H=`world_resource_packs.json`,U=`worlds`;var W=class{properties={};constructor(e){this.name=e}name},G=class{directory;worlds=new Map;constructor(e){this.directory=e}async create(e){e.options??={};let t=f(this.directory,e.options[`level-name`]??=crypto.randomUUID()),n=new W(e.options[`level-name`]);return Object.assign(n.properties,e.options),a(t)||await s(t),e.behaviorPacks&&await u(f(t,V),JSON.stringify(e.behaviorPacks.map(({version:e,uuid:t})=>({version:e,pack_id:t})))),e.resourcePacks&&await u(f(t,H),JSON.stringify(e.resourcePacks.map(({version:e,uuid:t})=>({version:e,pack_id:t})))),n}},K=class{directory;properties;configPermissions;worlds;constructor(e){this.directory=p(e),this.properties=new F(p(this.directory,R)),this.configPermissions=new I(p(this.directory,B,z)),this.worlds=new G(p(this.directory,U))}async include(e){}async install(e){let t=new Set;return await e.pipeTo(new P({onFile:async(e,n)=>{let r=p(this.directory,e.path);if(!r.startsWith(this.directory))throw ReferenceError(`Security critical path provided: `+e.path);a(d(r))||await s(d(r),{recursive:!0});let c=n.pipeTo(m.toWeb(i(r))).then(t=>e.path===`bedrock_server`?o(r,493):null).then(e=>void t.delete(c),e=>void 0);t.add(c)}})),await Promise.all(t),this.load()}async installFromURL(e){let t=await fetch(e).catch(e=>null);if(!t||!t.ok)throw ReferenceError(`Failed to fetch resource from: `+e);let n=t.body;if(!n)throw ReferenceError(`Failed to fetch resource data: `+e);return this.install(n)}async load(){return await this.properties.load(),await this.configPermissions.load(),this}async runWithTestConfig(e,t){return await u(f(this.directory,L),JSON.stringify(e)),await this.runInternal(t)}async run(e){return await l(f(this.directory,L)).catch(e=>null),this.runInternal(e)}getExecutableFile(){let e=f(this.directory,`bedrock_server`);return a(e)?e:a(e+`.exe`)?e+`.exe`:null}async runInternal(e){let t=this.getExecutableFile();if(!t)throw ReferenceError(`Corrupted installation, failed to found executable`);return await this.properties.save(),await this.configPermissions.save(),y.run(t,e??[],this.directory)}async runWorld(e){return this.properties.merge(e.properties),this.run([])}};const q=`https://net-secondary.web.minecraft-services.net/api/v1.0/download/links`,J=`https://raw.githubusercontent.com/Bedrock-OSS/BDS-Versions/main`,Y=`${J}/versions.json`;async function X(e){let t=`serverBedrock`;switch(e.is_preview&&(t+=`Preview`),e.platform){case`win32`:t+=`Windows`;break;case`linux`:t+=`Linux`;break;default:return null}let n=await fetch(q).catch(e=>null);if(!n||!n.ok)return null;let r=await n.json().catch(e=>null);return!r||!r.result||!Array.isArray(r.result.links)?null:r.result.links.find(e=>e?.downloadType===t)?.downloadUrl??null}async function re(e){let t=e.platform===`win32`?`windows`:e.platform,n=await fetch(Y).catch(e=>null);if(!n||!n.ok)return null;let r=await n.json().catch(e=>null);if(!r)return null;let i=r[t];if(!i)return null;let a=i[e.is_preview?`preview`:`stable`];return!a||(n=await fetch(`${J}/${t}${e.is_preview?`_preview`:``}/${a}.json`),!n||!n.ok)||(r=await n.json().catch(e=>null),!r)?null:r.download_url??null}function Z(e){return re(e).then(t=>t??X(e))}const ie=15e3,ae=`docs`,oe=`metadata`;var Q=class{static DESCRIPTION=`METADATA DESCRIPTION`;static async Init(e){await Deno.remove(e.worlds.directory,{recursive:!0}).catch(e=>null);let t=await e.runWithTestConfig({generate_api_metadata:!0,generate_documentation:!0},null);t.stop(!0,ie);let n=await t.wait().catch(e=>(console.error(e),null));return n===null?-1:n}static*GetTasks(e){yield this.CopyDocsTask(f(e.directory,ae),oe)}static async CopyDocsTask(e,t){for await(let t of $(e))console.log(t);return 0}};async function*$(e,t){for await(let{name:n,isFile:r,isDirectory:i}of Deno.readDir(f(e,t??``))){let a=f(t??``,n);r&&(yield a),i&&(yield*$(e,a))}}async function se(){if(t!==`win32`&&t!==`linux`)throw new _(v.UnsupportedPlatform,`Unknown OS platform: ${t}`);let e=await Z({is_preview:g===`preview`,platform:t});if(!e)throw new _(v.UnavailableInstallationLink,`Link not available branch:${g} platform:${t}`);console.info(`Link found: `+e);let n=new K(h);console.info(`Installation started`),await n.installFromURL(e),console.info(`Installed`);let r=await Q.Init(n);if(r)throw new _(v.SubModuleFailed,`Submodule failed with error code: `+r);let i=await Promise.allSettled(Q.GetTasks(n));return console.log(i),console.log(await Array.fromAsync(Deno.readDir(`.`))),0}se().catch(e=>(console.error(e),e.CODE??ee)).then(Deno.exit);